# SimpleMethodCallListCreator 手順書

## 概要
SimpleMethodCallListCreator は、指定した Java ソースのメソッド呼び出し箇所を解析し一覧表示する Windows Forms アプリです。加えて、
メソッドリスト作成、タグジャンプ情報の埋め込み、関連ソースの収集といった補助機能を備えています。

主な特徴:
- Java ソース（*.java）のみを対象
- コメント（/* */、//）は解析対象外
- コンストラクタは除外
- 動的なメソッド呼び出しは非対応

## 動作環境
- Windows
- .NET Framework 4.8
- 対象ソース: Java（*.java）

## 起動方法
- `SimpleMethodCallListCreator.exe` を起動します。
  - `bin/Debug` または `bin/Release` 配下の exe を使用してください。

## 1. メソッド呼び出し一覧（メイン画面）
### 手順
1. **対象ファイルパス** に解析対象の Java ファイルを指定します。ドラッグ＆ドロップ、履歴入力、[参照] が利用できます。 
2. **呼出元メソッド**（任意）を指定すると、そのメソッド名と一致する呼び出しのみ表示します。 
3. **除外指定** を必要に応じて設定します（呼出先メソッド名のみが対象）。
4. **実行** をクリックします。
5. 結果が一覧（DataGridView）に表示されます。

### 結果列の意味
- **ファイルパス**: 対象ファイルのパス
- **ファイル名**: 対象ファイル名
- **クラス**: クラス名
- **呼出元メソッド**: 呼び出し元メソッド名
- **呼出先クラス**: 呼び出し先のクラス名／インスタンス名
  - 同一クラス内呼び出し: 空欄
  - インスタンス呼び出し: インスタンス名
  - クラスメソッド呼び出し: クラス名
- **呼出先メソッド**: 呼び出し先メソッド名
- **呼出先メソッド引数**: 呼び出し時の引数
- **行番号**: 呼び出し箇所の行番号

### 結果の操作
- 列見出し上の **フィルタ入力欄** で部分一致フィルタが可能（大文字小文字は無視）。
- **Ctrl + A**: 全行選択
- **Ctrl + C**: 選択行をタブ区切りでコピー
- **行のダブルクリック**: その行の呼び出し箇所にタグジャンプ
  - `App.config` の `SakuraEditorPath` に Sakura Editor のパスを設定すると Sakura で開きます。
  - 設定がない場合は既定の関連付けで開きます。

### 結果の出力/入力
- **結果出力**: 実行結果を TSV で出力（出力先は exe と同じフォルダ）。
  - ファイル名: `YYYYMMDD_HHMMSS.tsv`
- **結果入力**: 既存 TSV を読み込みます。
  - ヘッダ行は自動判定でスキップ
  - 8 列（FilePath, FileName, ClassName, CallerMethod, CalleeClass, CalleeMethod, CalleeMethodArguments, LineNumber）必須

## 2. 除外指定（呼出先メソッド名のみ）
メイン画面の **除外指定** ボタンから設定します。

- ルール: **始まる / 終わる / 含む / 一致**
- **正規表現** の使用可（.NET 正規表現）
- **大小区別** の指定可

例: Getter/Setter を除外する場合
- ルール: 始まる
- キーワード: `get` や `set`

## 3. その他の機能（[その他] ボタン）
### 3-1. メソッドリスト作成
**対象フォルダ配下のメソッド定義一覧** を TSV 出力します。

手順:
1. **対象フォルダパス** を指定
2. **対象拡張子**（Java）を選択
3. 必要に応じて **ステップカウント** や **詳細ログ出力** を指定
4. **メソッドリスト作成** をクリック

出力:
- 形式: TSV（UTF-8）
- ファイル名: `YYYYMMDD_HHMMSS.tsv`
- ヘッダ:
  - `FilePath, FileName, PackageName, ClassName, MethodSignature`
  - **ステップカウント** 有効時は `Steps` 列が追加
- **MethodSignature** は引数名を除き、型のみを出力（throws 句は除外）

#### 行番号版（ファイルパス＋行番号）
「その他」画面の **ファイルパス＋行番号** グループのメソッドリスト作成を使うと、
行番号列を含む TSV を作成します。

- ファイル名: `YYYYMMDD_HHMMSS_row.tsv`
- ヘッダに `RowNum` 列が追加

### 3-2. タグジャンプ情報の埋め込み
メソッド呼び出し行の末尾にタグジャンプ情報を追記します。

手順（通常モード）:
1. **メソッドリストパス** を指定（UTF-8）
2. **開始ソースファイルパス** を指定
3. **開始メソッド名** を指定（同名メソッドがある場合はメソッドシグネチャを記載）
4. **タグジャンプ情報の前につける文字列**（例: `//@ `）を指定
5. **実行**

手順（全メソッドモード）:
1. **全メソッドモード** を ON
2. **ソースルートフォルダパス** を指定
3. **実行**

動作:
- 呼び出し先がメソッドリストに存在する場合、その行の末尾にタグを追記します。
- 既存のタグがある場合は置き換えます。
- 呼び出し先が一意に特定できない場合は `//★ メソッド特定失敗` を付加します。
- 解析/埋め込み失敗の詳細は `Error_YYYYMMDD_HHMMSS.log` に出力されます。

#### 行番号版タグの埋め込み
「ファイルパス＋行番号」グループの **タグジャンプ埋め込み** を使うと、
タグ内容が **ファイルパス + 行番号** になります。行番号版メソッドリスト（RowNum 列あり）が必要です。

※ コマンドラインモードは **メソッドシグネチャ形式のタグのみ対応** です。

### 3-3. ファイル収集
メソッドリストを基に、開始メソッドから到達できる **関連ソース一式を収集** します。

手順:
1. **メソッドリストパス**（絶対パス）を指定
2. **ソースルートフォルダパス** を指定
3. **開始ソースファイルパス** を指定
4. **開始メソッド名** を指定（同名がある場合はシグネチャ指定）
5. **収集フォルダパス** を指定
6. **実行**

動作:
- 解析で到達したファイルを収集フォルダにコピー（相対パス構成を維持）
- メソッド特定失敗は `Error_YYYYMMDD_HHMMSS.log` に記録されます

## 4. コマンドライン／Sakura マクロ連携
### コマンドライン起動
タグジャンプ用に、行テキストをそのまま引数で渡せます。

```
SimpleMethodCallListCreator.exe "<行テキスト>" "<メソッドリストパス(任意)>"
```

- 行テキスト内のタグ形式（デフォルト）:
  - `//@ <FilePath>\t<MethodSignature>[\t<MethodListPath>]`
- `MethodListPath` がタグ内に含まれている場合はそれを優先します。
- タグ内にメソッドリストパスがない場合、コマンドライン引数 or 設定値を使用します。

### Sakura マクロ
`macros/` フォルダに以下のマクロがあります。

- `sakura_tag_jump.js`
  - 現在行を引数に exe を起動します。
  - 先頭の `EXE_PATH` を実行ファイルのパスに書き換えてください。
- `sakura_tag_backjump.js`
  - 直前の位置に戻る簡易バックジャンプです。

## 5. 設定とログ
- 設定ファイル: `settings.json`（exe と同じフォルダ）
- エラーログ: `Error_YYYYMMDD_HHMMSS.log`（exe と同じフォルダ）
- メソッドリスト詳細ログ: `methodlist.log`（詳細ログ ON 時）
